const { expect } = require('chai')

import { getMintSignature } from 'common/src/getMintSignature'

const { defaultFixture } = require('../_fixture')
const { getSigForMintV5, loadFixture } = require('../helpers')

const ONE_ETH = ethers.utils.parseEther('1')
const MINTER_ROLE = ethers.utils.keccak256(
  ethers.utils.toUtf8Bytes('MINTER_ROLE')
)

describe('OriginERC721V6 mint reentrancy', () => {
  let deployerAddress, exploit, factory, master, minter, nftv6, token

  before(async function () {
    const {
      factoryV6,
      nftv6: nftv6_,
      master: master_
    } = await loadFixture(defaultFixture)
    const { deployerAddr } = await getNamedAccounts()

    deployerAddress = deployerAddr
    factory = factoryV6
    master = master_
    minter = ethers.provider.getSigner(4)
    nftv6 = nftv6_
  })

  beforeEach(async function () {
    const tx = await factory
      .connect(master)
      .createTokenWithMinter(
        'Reenter',
        'REENTER',
        'https://nft.example.com/nft/',
        123,
        await minter.getAddress(),
        [await minter.getAddress()],
        [100]
      )

    const receipt = await tx.wait(1)

    const createTokenEvent = receipt.events.find(
      (e) => e.event === 'CreateToken'
    )

    token = nftv6.attach(createTokenEvent.args.addr)

    expect(await token.maxSupply()).to.equal(123)

    await deployments.deploy('Reentrancy_OriginERC721_v5', {
      from: deployerAddress,
      args: [token.address]
    })

    exploit = await ethers.getContract('Reentrancy_OriginERC721_v5')

    expect(await exploit.callsMade()).to.equal(0)
  })

  it('does not mint more than count', async function () {
    const block = await ethers.provider.getBlock()
    const price = ONE_ETH.div(2)
    const count = 5
    const mintLimit = 5
    const expires = block.timestamp + 5

    const sig = await getSigForMintV5({
      signer: minter,
      token,
      buyer: exploit.address, // Tokens need to be minted to exploit contract
      count,
      price,
      mintLimit,
      expires
    })

    const runs = 3
    await expect(
      exploit.mintSome(
        runs,
        //buyer,
        count,
        price,
        mintLimit,
        expires,
        sig,
        { value: price.mul(runs) }
      )
    ).to.be.revertedWith('Max mint limit')
  })

  it('does not mint entire collection', async function () {
    const block = await ethers.provider.getBlock()
    const price = ONE_ETH.div(2)
    const count = 5
    const mintLimit = 5
    const expires = block.timestamp + 5

    const sig = await getSigForMintV5({
      signer: minter,
      token,
      buyer: exploit.address, // Tokens need to be minted to exploit contract
      count,
      price,
      mintLimit,
      expires
    })

    const maxSupply = await token.maxSupply()

    await expect(
      exploit.mintAll(count, price, mintLimit, expires, sig, {
        value: price.mul(maxSupply)
      })
    ).to.be.revertedWith('Max mint limit')
  })
})

describe('OriginERC721V6 mint limited reentrancy', () => {
  let deployerAddress,
    exploit,
    factory,
    master,
    minter,
    minterAddr,
    nftv6,
    token
  const expires = 9999999999

  before(async function () {
    const {
      factoryV6,
      nftv6: nftv6_,
      master: master_
    } = await loadFixture(defaultFixture)
    const { deployerAddr } = await getNamedAccounts()

    deployerAddress = deployerAddr
    factory = factoryV6
    master = master_
    minter = ethers.provider.getSigner(4)
    nftv6 = nftv6_
  })

  beforeEach(async function () {
    minterAddr = await minter.getAddress()
    const tx = await factory
      .connect(master)
      .createTokenWithMinter(
        'Reenter',
        'REENTER',
        'https://nft.example.eth/nft/',
        19,
        minterAddr,
        [minterAddr],
        [100]
      )

    const receipt = await tx.wait(1)

    const createTokenEvent = receipt.events.find(
      (e) => e.event === 'CreateToken'
    )

    token = nftv6.attach(createTokenEvent.args.addr)

    await deployments.deploy('ERC721V6Reentrancy', {
      from: deployerAddress,
      args: [token.address, 20, expires]
    })

    exploit = await ethers.getContract('ERC721V6Reentrancy')

    expect(await exploit.target()).to.equal(token.address)
  })

  it('does not mint more than count', async function () {
    const count = 10
    const mintLimit = 20

    expect(await token.hasRole(MINTER_ROLE, minterAddr)).is.true

    const { signature, hash } = await getMintSignature({
      chainId: 31337,
      minter,
      token,
      buyer: exploit.address,
      count,
      price: 0,
      mintLimit,
      expires
    })

    const expectedSigner = ethers.utils.verifyMessage(
      ethers.utils.arrayify(hash),
      signature
    )
    expect(expectedSigner).to.equal(minterAddr)
    await expect(exploit.mint(signature)).to.be.revertedWith('Invalid sequence')
  })
})
